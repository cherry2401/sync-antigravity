# Browser Relay Proxy - Triá»ƒn khai hoÃ n táº¥t ğŸŒ

## Tá»•ng quan

ÄÃ£ nÃ¢ng cáº¥p thÃ nh cÃ´ng Clawdbot App Client thÃ nh **Proxy Ä‘iá»u khiá»ƒn trÃ¬nh duyá»‡t**, cho phÃ©p Chopper/Gateway gá»­i lá»‡nh CDP (Chrome DevTools Protocol) tá»« xa Ä‘á»ƒ Ä‘iá»u khiá»ƒn Chrome trÃªn mÃ¡y ngÆ°á»i dÃ¹ng.

---

## Kiáº¿n trÃºc há»‡ thá»‘ng

```mermaid
graph LR
    A[Chrome Extension<br/>Port 18792] -->|WebSocket| B[App Client<br/>BrowserRelay Service]
    B -->|Auth Token| C[Gateway Bridge<br/>/api/client/bridge]
    C --> D[Chopper Server]
    B -->|Fallback| E[File-Based<br/>cdp_inbound.json<br/>cdp_outbound.json]
    E -->|SSH| D
```

---

## File má»›i táº¡o

### [Má»šI] [browserRelay.ts](file:///f:/Python/OpenSSH/clawdbot-client/electron/services/browserRelay.ts)

**Service cá»‘t lÃµi triá»ƒn khai:**

1. **WebSocket Server ná»™i bá»™ (Port 18792)**
   - Nháº­n káº¿t ná»‘i tá»« Chrome Extension
   - Xá»­ lÃ½ handshake tá»« Extension vá»›i `tabId` vÃ  `url`
   - Tá»± Ä‘á»™ng pháº£n há»“i ping/pong Ä‘á»ƒ giá»¯ káº¿t ná»‘i

2. **Káº¿t ná»‘i Gateway Bridge**
   - Káº¿t ná»‘i tá»›i `wss://${gatewayUrl}/api/client/bridge`
   - Gá»­i header `Authorization: Bearer ${token}`
   - Gá»­i tin nháº¯n Ä‘Äƒng kÃ½ vá»›i kháº£ nÄƒng cá»§a client
   - Tá»± Ä‘á»™ng káº¿t ná»‘i láº¡i khi bá»‹ ngáº¯t (delay 5s)

3. **Fallback qua file cho SSH**
   - Theo dÃµi `src/cdp_inbound.json` má»—i 500ms
   - Ghi pháº£n há»“i vÃ o `src/cdp_outbound.json`
   - Cho phÃ©p Chopper gá»­i lá»‡nh qua SSH báº±ng cÃ¡ch sá»­a file

4. **Xá»­ lÃ½ lá»‡nh CDP**
   - Chuyá»ƒn tiáº¿p lá»‡nh tá»« Gateway â†’ Extension
   - Theo dÃµi lá»‡nh Ä‘ang chá» vá»›i timeout 30s
   - Tráº£ pháº£n há»“i/lá»—i vá» Gateway

**CÃ¡c method quan trá»ng:**
- [start(config)](file:///f:/Python/OpenSSH/clawdbot-client/electron/services/browserRelay.ts#67-84) - Khá»Ÿi táº¡o vÃ  cháº¡y táº¥t cáº£ thÃ nh pháº§n
- [sendToExtension(command)](file:///f:/Python/OpenSSH/clawdbot-client/electron/services/browserRelay.ts#283-307) - Gá»­i lá»‡nh CDP vá»›i Promise
- [getStatus()](file:///f:/Python/OpenSSH/clawdbot-client/electron/services/browserRelay.ts#363-382) - Tráº£ vá» tráº¡ng thÃ¡i káº¿t ná»‘i hiá»‡n táº¡i
- [stop()](file:///f:/Python/OpenSSH/clawdbot-client/electron/services/browserRelay.ts#383-411) - Dá»n dáº¹p táº¥t cáº£ tÃ i nguyÃªn

---

## File Ä‘Ã£ sá»­a

### [Sá»¬A] [main.ts](file:///f:/Python/OpenSSH/clawdbot-client/electron/main.ts)

**Thay Ä‘á»•i:**
- Import [getBrowserRelay](file:///f:/Python/OpenSSH/clawdbot-client/electron/services/browserRelay.ts#416-422) singleton
- ThÃªm biáº¿n `browserRelay`
- Khá»Ÿi táº¡o relay trong [reloadGatewayClient()](file:///f:/Python/OpenSSH/clawdbot-client/electron/main.ts#307-386) sau khi káº¿t ná»‘i Gateway
- ThÃªm IPC handler `relay:getStatus`
- Dá»n dáº¹p relay khi `window-all-closed`

**Console log khi khá»Ÿi Ä‘á»™ng:**
```
ğŸŒ Initializing Browser Relay...
ğŸŒ [BrowserRelay] Service created
ğŸŒ [BrowserRelay] Local server listening on port 18792
ğŸŒ [BrowserRelay] File watcher started
   ğŸ“¥ Inbound (commands): F:\Python\OpenSSH\clawdbot-client\src\cdp_inbound.json
   ğŸ“¤ Outbound (responses): F:\Python\OpenSSH\clawdbot-client\src\cdp_outbound.json
ğŸŒ [BrowserRelay] Connecting to Gateway bridge: wss://clawdbot.myphamhaki.id.vn/api/client/bridge
âœ… Browser Relay started on port 18792
```

---

### [Sá»¬A] [client.ts](file:///f:/Python/OpenSSH/clawdbot-client/electron/services/client.ts)

**Thay Ä‘á»•i:**
- ThÃªm method [getClientId()](file:///f:/Python/OpenSSH/clawdbot-client/electron/services/client.ts#77-83) Ä‘á»ƒ láº¥y `clientId` tá»« private field

---

### [Sá»¬A] [StatusBar.tsx](file:///f:/Python/OpenSSH/clawdbot-client/src/components/StatusBar.tsx)

**Thay Ä‘á»•i:**
- ThÃªm interface [RelayStatus](file:///f:/Python/OpenSSH/clawdbot-client/src/components/StatusBar.tsx#10-16)
- ThÃªm icon Globe tá»« lucide-react
- ThÃªm polling tráº¡ng thÃ¡i relay (má»—i 3s qua IPC `relay:getStatus`)
- ThÃªm indicator Browser Relay vá»›i mÃ u Ä‘á»™ng:
  - ğŸŸ¢ **Xanh lÃ¡** = Cáº£ Extension vÃ  Gateway Ä‘á»u káº¿t ná»‘i
  - ğŸŸ¡ **VÃ ng** = Chá»‰ Extension HOáº¶C Gateway káº¿t ná»‘i
  - âš« **XÃ¡m** = KhÃ´ng káº¿t ná»‘i

**NhÃ£n tráº¡ng thÃ¡i:**
- "Browser Relay" - Káº¿t ná»‘i Ä‘áº§y Ä‘á»§
- "Ext Only" - Extension káº¿t ná»‘i, Gateway ngáº¯t
- "GW Only" - Gateway káº¿t ná»‘i, Extension chÆ°a káº¿t ná»‘i
- "Relay Off" - Cáº£ hai Ä‘á»u ngáº¯t

**Tooltip:** Hiá»ƒn thá»‹ URL tab hiá»‡n táº¡i khi Extension káº¿t ná»‘i

---

## Tráº¡ng thÃ¡i hiá»‡n táº¡i

### âœ… ÄÃ£ hoÃ n thÃ nh
- [x] WebSocket server ná»™i bá»™ trÃªn port 18792
- [x] Káº¿t ná»‘i Gateway bridge vá»›i auth token
- [x] Fallback qua file SSH
- [x] IPC handler Ä‘á»ƒ poll tráº¡ng thÃ¡i
- [x] UI indicator trÃªn StatusBar
- [x] Logic tá»± Ä‘á»™ng káº¿t ná»‘i láº¡i
- [x] Logging chi tiáº¿t

### â³ ChÆ°a hoÃ n thÃ nh
- [ ] Triá»ƒn khai endpoint `/api/client/bridge` trÃªn Gateway
- [ ] PhÃ¡t triá»ƒn/test Chrome Extension
- [ ] Test luá»“ng lá»‡nh CDP end-to-end

---

## HÆ°á»›ng dáº«n kiá»ƒm tra

### 1. **Test WebSocket Server ná»™i bá»™**

DÃ¹ng `wscat` Ä‘á»ƒ verify server:

```bash
wscat -c ws://localhost:18792
```

Gá»­i handshake:
```json
{"type": "handshake", "tabId": 123, "url": "https://example.com"}
```

Pháº£n há»“i mong Ä‘á»£i:
```json
{"type": "handshake_ack", "status": "connected", "clientId": "VuLinh-PC"}
```

StatusBar sáº½ cáº­p nháº­t thÃ nh **"Ext Only"** (mÃ u vÃ ng).

---

### 2. **Test lá»‡nh SSH qua file**

Táº¡o lá»‡nh CDP trong `src/cdp_inbound.json`:

```json
{
  "id": 1,
  "method": "Page.navigate",
  "params": {
    "url": "https://google.com"
  }
}
```

**Káº¿t quáº£ mong Ä‘á»£i:**
- App phÃ¡t hiá»‡n thay Ä‘á»•i file trong vÃ²ng 500ms
- Náº¿u Extension Ä‘Ã£ káº¿t ná»‘i: Lá»‡nh Ä‘Æ°á»£c chuyá»ƒn tiáº¿p tá»›i Chrome
- Pháº£n há»“i Ä‘Æ°á»£c ghi vÃ o `src/cdp_outbound.json`
- File inbound Ä‘Æ°á»£c xÃ³a vá» `{}`

---

### 3. **Test E2E Ä‘áº§y Ä‘á»§** (Cáº§n Extension + Gateway)

1. CÃ i Ä‘áº·t Chrome Extension
2. Extension káº¿t ná»‘i tá»›i `ws://localhost:18792`
3. Chopper gá»­i lá»‡nh qua Gateway bridge
4. App chuyá»ƒn tiáº¿p tá»›i Extension
5. Extension thá»±c thi lá»‡nh CDP trong Chrome
6. Pháº£n há»“i tráº£ vá»: Extension â†’ App â†’ Gateway â†’ Chopper

---

## YÃªu cáº§u Gateway Bridge

Gateway cáº§n triá»ƒn khai:

**Endpoint:** `ws://${gatewayUrl}/api/client/bridge`

**XÃ¡c thá»±c:**
- Nháº­n header `Authorization: Bearer ${token}`
- Validate danh tÃ­nh client

**Äá»‹nh dáº¡ng message:**

**Tá»« App Client (ÄÄƒng kÃ½):**
```json
{
  "type": "register",
  "clientId": "VuLinh-PC",
  "capabilities": ["cdp", "browser-control"]
}
```

**Tá»« Gateway (Lá»‡nh CDP):**
```json
{
  "id": 1,
  "method": "Page.navigate",
  "params": { "url": "https://example.com" }
}
```

**Tá»« App Client (Pháº£n há»“i CDP):**
```json
{
  "type": "cdp_response",
  "clientId": "VuLinh-PC",
  "tabId": 123,
  "payload": {
    "id": 1,
    "result": { ... }
  }
}
```

---

## BÆ°á»›c tiáº¿p theo

1. **Verify Server ná»™i bá»™:** Test báº±ng `wscat` Ä‘á»ƒ confirm port 18792 Ä‘ang láº¯ng nghe
2. **Kiá»ƒm tra StatusBar:** XÃ¡c nháº­n indicator "Relay Off" xuáº¥t hiá»‡n
3. **Triá»ƒn khai Gateway Bridge:** ThÃªm WebSocket endpoint vÃ o Gateway
4. **PhÃ¡t triá»ƒn Chrome Extension:** Táº¡o extension káº¿t ná»‘i tá»›i localhost:18792
5. **Test Fallback qua file:** Validate luá»“ng lá»‡nh SSH qua file JSON

---

## Ghi chÃº ká»¹ thuáº­t

- **Port 18792** hiá»‡n Ä‘Ã£ Ä‘Æ°á»£c dÃ nh riÃªng cho Browser Relay
- **File watcher** cháº¡y liÃªn tá»¥c, kiá»ƒm tra má»—i 500ms
- **Káº¿t ná»‘i Gateway** tá»± Ä‘á»™ng káº¿t ná»‘i láº¡i khi bá»‹ lá»—i
- **KhÃ´ng xÃ¡c thá»±c ná»™i bá»™** - localhost Ä‘Æ°á»£c tin tÆ°á»Ÿng máº·c Ä‘á»‹nh
- **XÃ¡c thá»±c token** báº¯t buá»™c cho Gateway bridge
- **Logging chi tiáº¿t** vá»›i prefix ğŸŒ Ä‘á»ƒ dá»… lá»c

---

## Xá»­ lÃ½ sá»± cá»‘

**Lá»—i "Port 18792 already in use"**
- Instance khÃ¡c cá»§a App cÃ³ thá»ƒ Ä‘ang cháº¡y
- DÃ¹ng `netstat -ano | findstr 18792` Ä‘á»ƒ kiá»ƒm tra

**"Gateway bridge disconnected"**
- Endpoint Gateway cÃ³ thá»ƒ chÆ°a tá»“n táº¡i (bÃ¬nh thÆ°á»ng)
- Kiá»ƒm tra Gateway logs Ä‘á»ƒ xem lá»—i WebSocket
- Verify auth token Ä‘Ãºng chÆ°a

**"Extension not connecting"**
- Äáº£m báº£o Extension káº¿t ná»‘i tá»›i `ws://localhost:18792`
- Kiá»ƒm tra console cá»§a Extension Ä‘á»ƒ xem lá»—i káº¿t ná»‘i
- Verify port khÃ´ng bá»‹ firewall cháº·n

**Tráº¡ng thÃ¡i hiá»‡n "Relay Off"**
- BÃ¬nh thÆ°á»ng náº¿u Extension chÆ°a cÃ i Ä‘áº·t
- Gateway endpoint tráº£ vá» 404 (bÃ¬nh thÆ°á»ng cho tá»›i khi triá»ƒn khai)
- Fallback qua file váº«n hoáº¡t Ä‘á»™ng cho lá»‡nh SSH

---

## VÃ­ dá»¥ sá»­ dá»¥ng qua SSH

Chopper cÃ³ thá»ƒ Ä‘iá»u khiá»ƒn trÃ¬nh duyá»‡t ngay bÃ¢y giá» báº±ng cÃ¡ch:

1. **SSH vÃ o mÃ¡y anh VÅ©**
2. **Ghi lá»‡nh CDP vÃ o file:**
   ```bash
   echo '{"id":1,"method":"Page.navigate","params":{"url":"https://google.com"}}' > F:\Python\OpenSSH\clawdbot-client\src\cdp_inbound.json
   ```
3. **Äá»£i 500ms**
4. **Äá»c káº¿t quáº£:**
   ```bash
   cat F:\Python\OpenSSH\clawdbot-client\src\cdp_outbound.json
   ```

Äiá»u nÃ y hoáº¡t Ä‘á»™ng **ngay láº­p tá»©c** mÃ  khÃ´ng cáº§n Gateway Bridge!
