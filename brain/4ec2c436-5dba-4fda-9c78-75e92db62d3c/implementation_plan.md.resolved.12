# K·∫ø ho·∫°ch Fix Extension-Client Connection

## V·∫•n ƒë·ªÅ hi·ªán t·∫°i

**Quan s√°t:**
- ‚úÖ App Client port 18792 LISTENING
- ‚úÖ Extension ƒë√£ load v√†o Chrome
- ‚ùå Extension b√°o "Relay not reachable" (ƒë·ªè)
- ‚ùå StatusBar v·∫´n "CDP Off"

**Root Cause:**
Extension kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c WebSocket t·ªõi `ws://127.0.0.1:18792/extension`

---

## Debug Plan

### Step 1: Ki·ªÉm tra Extension WebSocket URL

**Hi·ªán t·∫°i Extension connect t·ªõi:**
```javascript
ws://127.0.0.1:${port}/extension
```

**App Server endpoint:**
```typescript
// browserRelay.ts
this.wss.on('connection', (ws, req) => ...)
```

**Action:**
1. Xem Extension console log (F12 trong Extension options page)
2. T√¨m error: "WebSocket connect failed" ho·∫∑c "ERR_CONNECTION_REFUSED"
3. Check WebSocket path c√≥ ƒë√∫ng kh√¥ng

---

### Step 2: Ki·ªÉm tra App Server cho ph√©p Extension connection

**Possible issues:**
- CORS blocking
- WebSocket server kh√¥ng accept connections t·ª´ `chrome-extension://`
- Path `/extension` kh√¥ng t·ªìn t·∫°i

**Fix:**
- S·ª≠a [browserRelay.ts](file:///f:/Python/OpenSSH/clawdbot-client/electron/services/browserRelay.ts) ƒë·ªÉ log incoming connections
- Th√™m CORS headers n·∫øu c·∫ßn
- ƒê·∫£m b·∫£o WebSocket server accept t·ª´ localhost

---

### Step 3: Test Connection tr·ª±c ti·∫øp

**T·∫°o test HTML page:**
```html
<!DOCTYPE html>
<html>
<body>
  <h1>WebSocket Test</h1>
  <button onclick="testWS()">Test Connection</button>
  <pre id="log"></pre>
  
  <script>
    function testWS() {
      const ws = new WebSocket('ws://127.0.0.1:18792/extension');
      
      ws.onopen = () => {
        log('‚úÖ Connected!');
        ws.send(JSON.stringify({ type: 'test' }));
      };
      
      ws.onerror = (e) => {
        log('‚ùå Error: ' + e);
      };
      
      ws.onclose = () => {
        log('‚ö†Ô∏è Closed');
      };
    }
    
    function log(msg) {
      document.getElementById('log').innerText += msg + '\n';
    }
  </script>
</body>
</html>
```

---

## Implementation Plan

### Phase 1: Fix WebSocket Path

#### [MODIFY] [browserRelay.ts](file:///f:/Python/OpenSSH/clawdbot-client/electron/services/browserRelay.ts)

**Changes:**
1. Th√™m logging cho incoming WebSocket connections
2. Log request URL v√† headers
3. Ensure `/extension` path ƒë∆∞·ª£c route ƒë√∫ng

```typescript
this.wss.on('connection', (ws, req) => {
    console.log('üåê [BrowserRelay] üîå Connection from:', req.socket.remoteAddress);
    console.log('üåê [BrowserRelay] üìç Path:', req.url);
    console.log('üåê [BrowserRelay] üì® Headers:', req.headers);
    
    // ... existing code
});
```

---

### Phase 2: Fix Extension WebSocket Connection

#### [MODIFY] [background.js](file:///f:/Python/OpenSSH/chrome-extension/background.js)

**Current code:**
```javascript
const wsUrl = `ws://127.0.0.1:${port}/extension`
```

**Add retry logic:**
```javascript
async function ensureRelayConnection() {
  if (relayWs && relayWs.readyState === WebSocket.OPEN) return
  if (relayConnectPromise) return await relayConnectPromise

  relayConnectPromise = (async () => {
    const port = await getRelayPort()
    const wsUrl = `ws://127.0.0.1:${port}/extension`
    
    console.log('[Extension] Connecting to:', wsUrl)
    
    // ... existing connection code
  })()
}
```

---

### Phase 3: Add Connection Health Check

#### [NEW] Test page ƒë·ªÉ verify connection

**File:** `f:\Python\OpenSSH\clawdbot-client\test-ws.html`

T·∫°o simple test page ƒë·ªÉ verify WebSocket server ho·∫°t ƒë·ªông.

---

### Phase 4: Update Auto-Attach v·ªõi error handling

#### [MODIFY] [background.js](file:///f:/Python/OpenSSH/chrome-extension/background.js)

**Improve auto-attach listener:**
```javascript
chrome.tabs.onUpdated.addListener(async (tabId, changeInfo, tab) => {
  if (changeInfo.status !== 'complete') return
  if (tab.url && (tab.url.startsWith('chrome://') || tab.url.startsWith('chrome-extension://'))) return
  if (tabs.has(tabId)) return
  
  console.log(`üöÅ [Auto-Attach] Tab ${tabId} loaded: ${tab.url}`)
  
  tabs.set(tabId, { state: 'connecting' })
  setBadge(tabId, 'connecting')
  
  try {
    // RETRY v·ªõi timeout
    await ensureRelayConnection()
    await attachTab(tabId)
    console.log(`üöÅ [Auto-Attach] ‚úÖ Tab ${tabId} attached successfully`)
  } catch (err) {
    tabs.delete(tabId)
    setBadge(tabId, 'error')
    console.warn(`üöÅ [Auto-Attach] ‚ùå Failed:`, err.message)
    
    // RETRY after 3s
    setTimeout(() => {
      console.log(`üöÅ [Auto-Attach] üîÑ Retrying tab ${tabId}...`)
      chrome.tabs.onUpdated.removeListener(arguments.callee)
      chrome.tabs.reload(tabId)
    }, 3000)
  }
})
```

---

## Verification Plan

### Test 1: WebSocket Server

```powershell
# Check port
netstat -ano | findstr "18792"

# Should see LISTENING
```

### Test 2: Extension Connection

1. Load Extension
2. Open Chrome DevTools ‚Üí Console
3. Should see:
   ```
   [Extension] Connecting to: ws://127.0.0.1:18792/extension
   [Extension] ‚úÖ WebSocket connected
   ```

### Test 3: Auto-Attach

1. Open new tab (google.com)
2. Wait 2-3s
3. Check:
   - ‚úÖ Extension badge shows "ON"
   - ‚úÖ App console shows "Extension connected"
   - ‚úÖ StatusBar shows üü¢ "Browser Relay"

---

## Fallback Options

### Option A: N·∫øu WebSocket v·∫´n kh√¥ng ho·∫°t ƒë·ªông

**D√πng HTTP Polling thay v√¨ WebSocket:**
- Extension poll `http://127.0.0.1:18792/status` m·ªói 2s
- G·ª≠i commands qua POST requests

### Option B: N·∫øu CORS blocking

**Add CORS headers:**
```typescript
this.server.on('request', (req, res) => {
  res.setHeader('Access-Control-Allow-Origin', '*')
  res.setHeader('Access-Control-Allow-Methods', 'GET, POST')
})
```

---

## Success Criteria

‚úÖ **M·ªü App Client**
‚úÖ **Load Extension v√†o Chrome**
‚úÖ **M·ªü/reload tab**
‚Üí Badge t·ª± ƒë·ªông ON
‚Üí StatusBar üü¢ Browser Relay
‚Üí Console: "Extension connected"

**Kh√¥ng c·∫ßn thao t√°c g√¨ kh√°c!**
