# Auto CDP Connector - HoÃ n thÃ nh! ğŸ¯

## Tá»•ng quan

ÄÃ£ triá»ƒn khai tÃ­nh nÄƒng **Auto CDP Connector** cho phÃ©p App Client tá»± Ä‘á»™ng káº¿t ná»‘i tá»›i Chrome qua port 9222, loáº¡i bá» bÆ°á»›c báº¥m "Attach" thá»§ cÃ´ng.

---

## Kiáº¿n trÃºc má»›i

```mermaid
graph LR
    A[Chrome :9222] -->|WebSocket| B[App Client<br/>CDP Scanner]
    B -->|CDP Events| C[Gateway/SSH]
    C --> D[Chopper]
    
    E[Extension<br/>Port 18792] -.->|Backup| B
```

---

## Thay Ä‘á»•i chÃ­nh

### [MODIFY] [browserRelay.ts](file:///f:/Python/OpenSSH/clawdbot-client/electron/services/browserRelay.ts)

**TÃ­nh nÄƒng má»›i:**
- [startCDPScanner()](file:///f:/Python/OpenSSH/clawdbot-client/electron/services/browserRelay.ts#147-165) - QuÃ©t port 9222 má»—i 3 giÃ¢y
- [fetchCDPTargets()](file:///f:/Python/OpenSSH/clawdbot-client/electron/services/browserRelay.ts#193-228) - Láº¥y danh sÃ¡ch targets tá»« `http://localhost:9222/json`
- [connectToCDP()](file:///f:/Python/OpenSSH/clawdbot-client/electron/services/browserRelay.ts#229-301) - Káº¿t ná»‘i WebSocket trá»±c tiáº¿p tá»›i Chrome
- [sendCDPCommand()](file:///f:/Python/OpenSSH/clawdbot-client/electron/services/browserRelay.ts#461-498) - Route command: CDP Direct â†’ Extension (fallback)

**Æ¯u tiÃªn káº¿t ná»‘i:**
1. **CDP Direct** (port 9222) - MÅ©i nhá»n
2. **Extension** (port 18792) - Háº­u phÆ°Æ¡ng

**Æ¯u tiÃªn target:**
1. Tabs cÃ³ type `page`
2. KhÃ´ng pháº£i `chrome://` hoáº·c `chrome-extension://`
3. Tab Ä‘áº§u tiÃªn (thÆ°á»ng lÃ  active)

---

### [MODIFY] [StatusBar.tsx](file:///f:/Python/OpenSSH/clawdbot-client/src/components/StatusBar.tsx)

**Thay Ä‘á»•i UI:**
- ThÃªm tráº¡ng thÃ¡i `cdp_direct`
- Badge: **ğŸ¯ CDP Direct** (mÃ u xanh)
- Tooltip hiá»ƒn thá»‹ title vÃ  URL cá»§a tab Ä‘ang káº¿t ná»‘i
- Hint: "Start Chrome with --remote-debugging-port=9222"

---

## HÆ°á»›ng dáº«n sá»­ dá»¥ng

### Option 1: DÃ¹ng Script Launcher (KHUYáº¾N KHÃCH)

ÄÃ£ táº¡o sáºµn file **[Start-Chrome-Debug.bat](file:///f:/Python/OpenSSH/clawdbot-client/Start-Chrome-Debug.bat)** trong folder `clawdbot-client/`

**CÃ¡ch dÃ¹ng:**
1. Double-click file [Start-Chrome-Debug.bat](file:///f:/Python/OpenSSH/clawdbot-client/Start-Chrome-Debug.bat)
2. Script tá»± Ä‘á»™ng:
   - ÄÃ³ng táº¥t cáº£ Chrome cÅ©
   - Má»Ÿ Chrome má»›i vá»›i debugging
3. StatusBar tá»± Ä‘á»™ng hiá»‡n ğŸŸ¢ **ğŸ¯ CDP Direct**

**Ghim ra Desktop:**
- KÃ©o file [.bat](file:///f:/Python/OpenSSH/clawdbot-client/Start-Chrome-Debug.bat) ra Desktop táº¡o shortcut
- Má»—i láº§n cáº§n CDP Direct chá»‰ cáº§n double-click!

---

### Option 2: ThÃªm flag vÃ o Chrome shortcut (NÃ¢ng cao)

> [!WARNING]
> **Pháº£i Ä‘Ã³ng Táº¤T Cáº¢ Chrome cÅ© trÆ°á»›c khi má»Ÿ shortcut má»›i!**
> Náº¿u Chrome Ä‘ang cháº¡y, click shortcut chá»‰ má»Ÿ tab má»›i (khÃ´ng cÃ³ debugging).

**Windows:**

1. Click chuá»™t pháº£i vÃ o Chrome shortcut â†’ **Properties**
2. Trong Ã´ **Target**, thÃªm vÃ o cuá»‘i:
   ```
   --remote-debugging-port=9222
   ```
3. Káº¿t quáº£:
   ```
   "C:\Program Files\Google\Chrome\Application\chrome.exe" --remote-debugging-port=9222
   ```
4. Click **OK**

**Hoáº·c táº¡o shortcut má»›i:**
1. Chuá»™t pháº£i trÃªn Desktop â†’ New â†’ Shortcut
2. Nháº­p:
   ```
   "C:\Program Files\Google\Chrome\Application\chrome.exe" --remote-debugging-port=9222
   ```
3. Äáº·t tÃªn: **Chrome Debug**

---

### BÆ°á»›c 2: Khá»Ÿi Ä‘á»™ng

1. **ÄÃ³ng táº¥t cáº£ Chrome** (quan trá»ng!)
2. **Má»Ÿ Chrome báº±ng shortcut má»›i** (Chrome Debug)
3. **Má»Ÿ Clawdbot App Client**

---

### BÆ°á»›c 3: Kiá»ƒm tra

**Console App Client sáº½ hiá»ƒn thá»‹:**
```
ğŸŒ [BrowserRelay] Starting CDP scanner (port 9222)...
ğŸŒ [BrowserRelay] ğŸ¯ CDP target found: Google (https://www.google.com)
ğŸŒ [BrowserRelay] Connecting to CDP: ws://127.0.0.1:9222/devtools/page/ABC123
ğŸŒ [BrowserRelay] âœ… CDP Direct connected!
```

**StatusBar sáº½ hiá»ƒn thá»‹:**
- ğŸŸ¢ **ğŸ¯ CDP Direct** (mÃ u xanh)
- Hover Ä‘á»ƒ xem title vÃ  URL

---

## Test CDP Commands

### Qua SSH (File-based):

```bash
# Ghi lá»‡nh
echo '{"id":1,"method":"Page.navigate","params":{"url":"https://google.com"}}' > F:\Python\OpenSSH\clawdbot-client\src\cdp_inbound.json

# Äá»£i 1s rá»“i Ä‘á»c káº¿t quáº£
cat F:\Python\OpenSSH\clawdbot-client\src\cdp_outbound.json
```

### CÃ¡c lá»‡nh CDP phá»• biáº¿n:

```json
// Äiá»u hÆ°á»›ng trang
{"id":1,"method":"Page.navigate","params":{"url":"https://example.com"}}

// Chá»¥p screenshot
{"id":2,"method":"Page.captureScreenshot"}

// Láº¥y DOM
{"id":3,"method":"DOM.getDocument"}

// Evaluate JavaScript
{"id":4,"method":"Runtime.evaluate","params":{"expression":"document.title"}}
```

---

## Fallback Mode

Náº¿u Chrome khÃ´ng má»Ÿ vá»›i flag debugging:
- CDP Scanner váº«n cháº¡y ná»n (quÃ©t má»—i 3s)
- Extension mode váº«n hoáº¡t Ä‘á»™ng bÃ¬nh thÆ°á»ng
- StatusBar hiá»ƒn thá»‹ "CDP Off" hoáº·c "Ext Only"

Khi Chrome debug Ä‘Æ°á»£c detect:
- Tá»± Ä‘á»™ng chuyá»ƒn sang CDP Direct
- Extension bá»‹ bypass (nhÆ°ng váº«n sáºµn sÃ ng lÃ m backup)

---

## LÆ°u Ã½ quan trá»ng

> [!IMPORTANT]
> **Pháº£i Ä‘Ã³ng táº¥t cáº£ Chrome trÆ°á»›c khi má»Ÿ Chrome Debug!**
> Chrome chá»‰ cho phÃ©p 1 instance cháº¡y remote debugging.

> [!TIP]
> Äá»ƒ kiá»ƒm tra Chrome cÃ³ Ä‘ang cháº¡y debug mode khÃ´ng:
> Má»Ÿ `http://localhost:9222/json` trong trÃ¬nh duyá»‡t.
> Náº¿u tháº¥y JSON â†’ Chrome debug Ä‘ang hoáº¡t Ä‘á»™ng.

---

## Káº¿t quáº£ Ä‘áº¡t Ä‘Æ°á»£c

âœ… **Má»¥c tiÃªu Chopper:** "Anh VÅ© má»Ÿ Chrome + má»Ÿ App lÃ  tÃ´i cÃ³ thá»ƒ 'nhÃ¬n' tháº¥y ngay"

- KhÃ´ng cáº§n cÃ i Extension
- KhÃ´ng cáº§n click Attach
- Tá»± Ä‘á»™ng detect vÃ  káº¿t ná»‘i
- Fallback vá» Extension náº¿u cáº§n
