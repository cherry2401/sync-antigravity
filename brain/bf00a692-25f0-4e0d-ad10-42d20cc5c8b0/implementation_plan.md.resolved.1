# üîê Implementation Plan: Auth + Balance + Admin System

## T·ªïng quan

Th√™m backend Express.js v√†o d·ª± √°n Auto-Like ƒë·ªÉ:
- B·∫£o v·ªá BaoStar API key (hi·ªán ƒëang l·ªô ·ªü frontend)
- Qu·∫£n l√Ω t√†i kho·∫£n ng∆∞·ªùi d√πng & ƒëƒÉng nh·∫≠p
- Qu·∫£n l√Ω s·ªë d∆∞ & thanh to√°n
- Trang Admin qu·∫£n l√Ω users/ti·ªÅn/gi√°

---

## Ki·∫øn tr√∫c

```mermaid
flowchart LR
    subgraph FE["Frontend ‚Äî Vite React"]
        A[Login/Register] --> B[AuthContext]
        B --> C[Protected Routes]
        C --> D[Service Pages]
        D --> E[Deposit Page]
    end

    subgraph BE["Backend ‚Äî Express.js"]
        F[Auth Routes] --> G[JWT Middleware]
        G --> H[Orders API]
        G --> I[Balance API]
        G --> J[Admin API]
        H --> K[BaoStar Proxy]
    end

    subgraph DB["Database ‚Äî SQLite"]
        L[(users)]
        M[(transactions)]
        N[(orders)]
        O[(pricing_config)]
    end

    FE -->|JWT Token| BE
    BE --> DB
    K -->|Hidden API Key| P[BaoStar API]
```

---

## Pricing Model

| Nh√≥m d·ªãch v·ª• | Gi√° g·ªëc BaoStar | H·ªá s·ªë | Gi√° b√°n | VD 100 like |
|---|---|---|---|---|
| **Like th∆∞·ªùng** (like-gia-re, like-chat-luong, like-comment, comment, share, mat-live, mem-group) | `price_per` | **√ó1.5** (l·ªùi 50%) | `price_per √ó 1.5` | 54ƒë ‚Üí **81ƒë** |
| **VIP Like** (vip) | `price_per` | **√ó1.25** (l·ªùi 25%) | `price_per √ó 1.25` | 2,200ƒë ‚Üí **2,750ƒë** |
| **Follow/Page** (follow, like-page) | `price_per` | **√ó1.5** | `price_per √ó 1.5` | ‚Äî |

Admin c√≥ th·ªÉ thay ƒë·ªïi h·ªá s·ªë t·ª´ng d·ªãch v·ª• qua Admin Dashboard.

---

## Database Schema

```sql
-- Users
CREATE TABLE users (
    id            INTEGER PRIMARY KEY AUTOINCREMENT,
    username      TEXT UNIQUE NOT NULL,
    email         TEXT UNIQUE,
    phone         TEXT UNIQUE,
    password_hash TEXT NOT NULL,
    display_name  TEXT,
    balance       INTEGER DEFAULT 0,
    role          TEXT DEFAULT 'user',  -- 'user' | 'admin'
    is_active     BOOLEAN DEFAULT 1,
    created_at    DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at    DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- Transactions (n·∫°p/mua/ho√†n)
CREATE TABLE transactions (
    id            INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id       INTEGER NOT NULL REFERENCES users(id),
    type          TEXT NOT NULL,        -- 'deposit' | 'purchase' | 'refund'
    amount        INTEGER NOT NULL,
    balance_after INTEGER NOT NULL,
    description   TEXT,
    metadata      TEXT,                 -- JSON
    created_at    DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- Orders
CREATE TABLE orders (
    id               INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id          INTEGER NOT NULL REFERENCES users(id),
    baostar_order_id INTEGER,
    service_id       TEXT NOT NULL,
    package_name     TEXT NOT NULL,
    object_id        TEXT NOT NULL,
    quantity         INTEGER,
    sell_price       INTEGER NOT NULL,  -- Gi√° b√°n (tr·ª´ user)
    cost_price       INTEGER NOT NULL,  -- Gi√° g·ªëc BaoStar
    profit           INTEGER NOT NULL,  -- sell - cost
    status           TEXT DEFAULT 'processing',
    created_at       DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- Pricing Config (admin set)
CREATE TABLE pricing_config (
    id          INTEGER PRIMARY KEY AUTOINCREMENT,
    service_id  TEXT UNIQUE NOT NULL,
    markup      REAL NOT NULL DEFAULT 1.5,  -- H·ªá s·ªë nh√¢n
    updated_at  DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

---

## Th√¥ng tin n·∫°p ti·ªÅn

- **Ng√¢n h√†ng:** ACB
- **Ch·ªß TK:** Tr·∫ßn Ng·ªçc Thu
- **STK:** 15732191
- **Chi nh√°nh:** Ng√¢n h√†ng √Å Ch√¢u ACB Bu√¥n M√™ Thu·∫≠t
- **N·ªôi dung CK:** `NAPTIEN <username>`
- Hi·ªÉn th·ªã c·∫£ **QR code** + th√¥ng tin t√†i kho·∫£n

---

## Proposed Changes

### Phase 1: Backend Foundation

#### [NEW] server/package.json
- Express.js, better-sqlite3, bcrypt, jsonwebtoken, cors, dotenv

#### [NEW] server/index.ts
- Express server, CORS config, routes mount, error handler

#### [NEW] server/database/schema.sql
- T·∫°o 4 b·∫£ng: users, transactions, orders, pricing_config
- Seed admin user + pricing defaults

#### [NEW] server/config.ts
- Env vars: JWT_SECRET, BAOSTAR_API_KEY, PORT, DB_PATH

---

### Phase 2: Auth System

#### [NEW] server/routes/auth.ts

| Endpoint | Method | Body | Response |
|---|---|---|---|
| `/auth/register` | POST | `{username, password, email?, phone?}` | `{user, token}` |
| `/auth/login` | POST | `{identifier, password}` | `{user, token}` |
| `/auth/me` | GET | ‚Äî (JWT header) | `{user}` |

- `identifier` = username HO·∫∂C email HO·∫∂C SƒêT ‚Üí auto-detect

#### [NEW] server/middleware/auth.ts
- Verify JWT ‚Üí attach `req.user`
- Admin check middleware

---

### Phase 3: Purchase Flow (Proxy BaoStar)

#### [NEW] server/routes/orders.ts

| Endpoint | Method | Auth | Logic |
|---|---|---|---|
| `/api/orders` | POST | ‚úÖ | Check balance ‚Üí Tr·ª´ ti·ªÅn ‚Üí G·ªçi BaoStar ‚Üí L∆∞u order |
| `/api/orders` | GET | ‚úÖ | L·∫•y danh s√°ch ƒë∆°n h√†ng user |

- N·∫øu BaoStar l·ªói ‚Üí **auto refund** + ghi transaction
- Gi√° b√°n = gi√° g·ªëc √ó markup t·ª´ `pricing_config`

#### [MODIFY] server/routes/services.ts
- Proxy `/api/prices` v√† `/api/convert-uid` ƒë·∫øn BaoStar (public, no auth)

---

### Phase 4: Frontend Auth Integration

#### [NEW] src/contexts/AuthContext.tsx
- `AuthProvider`: qu·∫£n l√Ω JWT, user state, login/logout
- `useAuth()` hook: `{ user, login, register, logout, isAuthenticated }`

#### [NEW] src/pages/LoginPage.tsx
- Form ƒëƒÉng nh·∫≠p (username/email/SƒêT + MK)
- Link sang trang ƒëƒÉng k√Ω

#### [NEW] src/pages/RegisterPage.tsx
- 3 tab: Username / Email / SƒêT
- Form fields + validation

#### [NEW] src/pages/DepositPage.tsx
- Hi·ªÉn th·ªã QR code + th√¥ng tin TK ng√¢n h√†ng
- N·ªôi dung CK: `NAPTIEN <username>`
- L·ªãch s·ª≠ n·∫°p ti·ªÅn

#### [MODIFY] src/pages/ServicePage.tsx
- Submit ‚Üí check `isAuthenticated` ‚Üí redirect login n·∫øu ch∆∞a
- Check `balance >= totalPrice` ‚Üí b√°o l·ªói n·∫øu thi·∫øu
- Hi·ªÉn th·ªã gi√° b√°n (ƒë√£ markup) thay v√¨ gi√° g·ªëc
- Call backend `/api/orders` thay v√¨ tr·ª±c ti·∫øp BaoStar

#### [MODIFY] src/components/Header.tsx
- Hi·ªÉn th·ªã s·ªë d∆∞ + avatar/username n·∫øu ƒë√£ login
- N√∫t "ƒêƒÉng nh·∫≠p" n·∫øu ch∆∞a login

#### [MODIFY] src/components/Sidebar.tsx
- Th√™m links: "N·∫°p ti·ªÅn", "ƒêƒÉng xu·∫•t"
- ·∫®n "Admin" n·∫øu kh√¥ng ph·∫£i admin

#### [MODIFY] src/App.tsx
- Wrap `<AuthProvider>`
- Th√™m routes: `/login`, `/register`, `/deposit`, `/admin/*`

---

### Phase 5: Admin Dashboard

#### [NEW] src/pages/admin/AdminDashboard.tsx
- T·ªïng quan: s·ªë user, doanh thu, l·ª£i nhu·∫≠n

#### [NEW] src/pages/admin/AdminUsers.tsx
- Danh s√°ch users + search
- C·ªông ti·ªÅn cho user
- B·∫≠t/t·∫Øt t√†i kho·∫£n

#### [NEW] src/pages/admin/AdminPricing.tsx
- B·∫£ng gi√° t·ª´ng d·ªãch v·ª•: gi√° g·ªëc BaoStar | h·ªá s·ªë | gi√° b√°n
- Edit markup t·ª´ng d·ªãch v·ª•
- Preview gi√° b√°n realtime

#### [NEW] src/pages/admin/AdminOrders.tsx
- T·∫•t c·∫£ ƒë∆°n h√†ng, filter theo user/d·ªãch v·ª•/tr·∫°ng th√°i

#### [NEW] server/routes/admin.ts
- CRUD users, deposit, pricing config, orders list

---

### Phase 6: Security & Deploy

#### [MODIFY] vite.config.ts
- Dev proxy tr·ªè ƒë·∫øn local backend (`http://localhost:3001`)

#### [DELETE] VITE_API_KEY from .env
- API key ch·ªâ l∆∞u ·ªü backend [.env](file:///I:/Website/Auto-like/.env)

#### [NEW] server/.env
- `JWT_SECRET`, `BAOSTAR_API_KEY`, `PORT=3001`

---

## Build Checklist

```
Phase 1: Backend Foundation
  [ ] Init server/ v·ªõi Express + TypeScript + SQLite
  [ ] T·∫°o database schema + seed admin
  [ ] Config env vars

Phase 2: Auth System
  [ ] Register endpoint (username/email/phone)
  [ ] Login endpoint (auto-detect identifier)
  [ ] JWT middleware
  [ ] GET /auth/me

Phase 3: Purchase Flow
  [ ] Proxy /api/prices (public)
  [ ] Proxy /api/convert-uid (public)
  [ ] POST /api/orders (auth + balance check + BaoStar proxy + refund)
  [ ] GET /api/orders (user's orders)

Phase 4: Frontend Auth
  [ ] AuthContext + useAuth hook
  [ ] Login page
  [ ] Register page (3 tabs)
  [ ] Deposit page (QR + bank info)
  [ ] Protected ServicePage (check login + balance)
  [ ] Header: balance + user info
  [ ] Sidebar: deposit + logout links

Phase 5: Admin Dashboard
  [ ] Admin layout + routes
  [ ] User management + deposit
  [ ] Pricing management (markup editor)
  [ ] Order history viewer

Phase 6: Security & Deploy
  [ ] Remove API key from frontend
  [ ] Production build config
  [ ] Deploy frontend + backend
```

---

## Verification Plan

### Automated
- `npm run build` ‚Äî TypeScript compile check
- Test auth flow: register ‚Üí login ‚Üí get profile
- Test purchase: insufficient balance ‚Üí error, sufficient ‚Üí success ‚Üí BaoStar called

### Manual
- ƒêƒÉng k√Ω 3 c√°ch (username, email, SƒêT)
- ƒêƒÉng nh·∫≠p ‚Üí xem s·ªë d∆∞
- Admin c·ªông ti·ªÅn ‚Üí user th·∫•y
- Mua d·ªãch v·ª• ƒë·ªß ti·ªÅn ‚Üí th√†nh c√¥ng
- Mua thi·∫øu ti·ªÅn ‚Üí b√°o l·ªói
- Ch∆∞a login b·∫•m mua ‚Üí redirect
- Admin thay ƒë·ªïi markup ‚Üí gi√° c·∫≠p nh·∫≠t
