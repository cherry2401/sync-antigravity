# Extension V2 - N8n Webhook Integration

## T·ªïng Quan
Th√™m t√≠nh nƒÉng t·ª± ƒë·ªông ƒë·ªìng b·ªô cookies sang n8n webhook ƒë·ªÉ l∆∞u v√†o data table.

## Proposed Changes

### 1. UI Updates - Settings Section

#### [MODIFY] [sidebar.html](file:///d:/EXTENTIONS/custome-link_v2/sidebar.html)

Th√™m section m·ªõi trong Settings:

```html
<!-- Sau ph·∫ßn Cookie Input -->
<div class="section">
  <label>N8N Webhook URL:</label>
  <input 
    type="url" 
    id="webhookInput" 
    placeholder="https://auto.myphamhaki.id.vn/webhook/api-key-xxx"
    style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;"
  />
  <p class="tip">üí° Webhook s·∫Ω nh·∫≠n POST request v·ªõi cookies data</p>
  
  <div style="margin-top: 12px;">
    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
      <input type="checkbox" id="autoSyncCheckbox" />
      <span>T·ª± ƒë·ªông ƒë·ªìng b·ªô sau khi l·∫•y cookies</span>
    </label>
  </div>
</div>
```

### 2. Storage Updates

#### [MODIFY] [sidebar.js](file:///d:/EXTENTIONS/custome-link_v2/sidebar.js)

**Th√™m state variables:**
```javascript
let state = {
  // ... existing state
  webhookUrl: '',
  autoSync: false
};
```

**Load webhook settings on startup:**
```javascript
chrome.storage.local.get(['shopee_affiliate_cookie', 'n8n_webhook_url', 'auto_sync_enabled'], function(result) {
  if (result.shopee_affiliate_cookie) {
    state.cookie = result.shopee_affiliate_cookie;
    state.isConfigured = true;
  }
  if (result.n8n_webhook_url) {
    state.webhookUrl = result.n8n_webhook_url;
  }
  if (result.auto_sync_enabled !== undefined) {
    state.autoSync = result.auto_sync_enabled;
  }
  // ... show content
});
```

**Save webhook settings:**
```javascript
saveCookieBtn.addEventListener('click', function() {
  const cookie = cookieInput.value.trim();
  const webhookUrl = webhookInput.value.trim();
  const autoSync = autoSyncCheckbox.checked;
  
  if (!cookie) {
    alert('Vui l√≤ng nh·∫≠p Cookie');
    return;
  }
  
  chrome.storage.local.set({ 
    shopee_affiliate_cookie: cookie,
    n8n_webhook_url: webhookUrl,
    auto_sync_enabled: autoSync
  }, function() {
    state.cookie = cookie;
    state.webhookUrl = webhookUrl;
    state.autoSync = autoSync;
    state.isConfigured = true;
    showMainContent();
  });
});
```

---

### 3. Webhook Sync Function

#### [MODIFY] [sidebar.js](file:///d:/EXTENTIONS/custome-link_v2/sidebar.js)

**Th√™m function g·ª≠i data ƒë·∫øn webhook:**

```javascript
async function syncToWebhook(cookieString, cookieCount) {
  if (!state.webhookUrl) {
    console.log('No webhook URL configured, skipping sync');
    return { success: false, reason: 'no_url' };
  }
  
  try {
    console.log('Syncing to webhook:', state.webhookUrl);
    
    // Prepare data
    const payload = {
      cookies: cookieString,
      timestamp: new Date().toISOString(),
      cookie_count: cookieCount,
      user_id: extractUserId(cookieString), // Extract SPC_U value
      source: 'chrome_extension_v2'
    };
    
    console.log('Payload:', { ...payload, cookies: payload.cookies.substring(0, 100) + '...' });
    
    // Send to webhook
    const response = await fetch(state.webhookUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(payload)
    });
    
    if (!response.ok) {
      throw new Error(`Webhook returned status ${response.status}`);
    }
    
    const result = await response.json();
    console.log('‚úÖ Webhook sync successful:', result);
    
    return { success: true, data: result };
    
  } catch (error) {
    console.error('‚ùå Webhook sync failed:', error);
    return { success: false, error: error.message };
  }
}

// Helper function to extract user ID from cookies
function extractUserId(cookieString) {
  const match = cookieString.match(/SPC_U=([^;]+)/);
  return match ? match[1] : 'unknown';
}
```

**G·ªçi sync sau khi l·∫•y cookies th√†nh c√¥ng:**

Trong auto cookie button handler, sau khi l·∫•y cookies th√†nh c√¥ng:

```javascript
// Show success message
const cookieInfo = `‚úÖ ƒê√£ l·∫•y ${shopeeCookies.length} cookies (${cookieString.length} k√Ω t·ª±)`;
showError(cookieInfo);
// ... styling

// Auto sync if enabled
if (state.autoSync && state.webhookUrl) {
  console.log('Auto-syncing to webhook...');
  const syncResult = await syncToWebhook(cookieString, shopeeCookies.length);
  
  if (syncResult.success) {
    showError(`‚úÖ ƒê√£ l·∫•y ${shopeeCookies.length} cookies v√† ƒë·ªìng b·ªô v·ªõi N8n!`);
  } else {
    showError(`‚úÖ ƒê√£ l·∫•y ${shopeeCookies.length} cookies (‚ö†Ô∏è ƒê·ªìng b·ªô th·∫•t b·∫°i)`);
  }
}
```

---

### 4. Manual Sync Button (Optional)

#### [MODIFY] [sidebar.html](file:///d:/EXTENTIONS/custome-link_v2/sidebar.html)

Th√™m button ƒë·ªìng b·ªô th·ªß c√¥ng trong Settings:

```html
<button class="btn btn-secondary" id="testWebhookBtn" style="margin-top: 8px;">
  <span>üîÑ</span>
  <span>Test Webhook</span>
</button>
```

#### [MODIFY] [sidebar.js](file:///d:/EXTENTIONS/custome-link_v2/sidebar.js)

```javascript
testWebhookBtn.addEventListener('click', async function() {
  if (!state.webhookUrl) {
    alert('Vui l√≤ng nh·∫≠p Webhook URL tr∆∞·ªõc');
    return;
  }
  
  if (!state.cookie) {
    alert('Ch∆∞a c√≥ cookies ƒë·ªÉ test. Vui l√≤ng l·∫•y cookies tr∆∞·ªõc.');
    return;
  }
  
  testWebhookBtn.disabled = true;
  testWebhookBtn.innerHTML = '<span>‚è≥</span><span>ƒêang test...</span>';
  
  const result = await syncToWebhook(state.cookie, 0);
  
  if (result.success) {
    alert('‚úÖ Test webhook th√†nh c√¥ng!');
  } else {
    alert(`‚ùå Test webhook th·∫•t b·∫°i: ${result.error || result.reason}`);
  }
  
  testWebhookBtn.disabled = false;
  testWebhookBtn.innerHTML = '<span>üîÑ</span><span>Test Webhook</span>';
});
```

---

## Verification Plan

### Manual Testing

1. **C·∫•u h√¨nh webhook:**
   - Settings ‚Üí Nh·∫≠p webhook URL
   - Check "T·ª± ƒë·ªông ƒë·ªìng b·ªô"
   - L∆∞u

2. **Test auto-sync:**
   - L·∫•y cookies t·ª± ƒë·ªông
   - Ki·ªÉm tra n8n c√≥ nh·∫≠n ƒë∆∞·ª£c data kh√¥ng
   - Verify data structure ƒë√∫ng

3. **Test manual sync:**
   - Nh·∫•n "Test Webhook"
   - Verify th√¥ng b√°o success/error

4. **Error handling:**
   - Test v·ªõi URL sai ‚Üí Should show error
   - Test khi n8n offline ‚Üí Should handle gracefully

### N8n Webhook Setup

B·∫°n c·∫ßn t·∫°o webhook node trong n8n v·ªõi structure:

```json
{
  "cookies": "string",
  "timestamp": "string (ISO)",
  "cookie_count": "number",
  "user_id": "string",
  "source": "string"
}
```

## Notes

- Webhook URL ƒë∆∞·ª£c l∆∞u trong `chrome.storage.local`
- Auto-sync ch·ªâ ch·∫°y khi c√≥ webhook URL v√† checkbox enabled
- Sync failures kh√¥ng block extension ho·∫°t ƒë·ªông
- Console log ƒë·∫ßy ƒë·ªß ƒë·ªÉ debug
