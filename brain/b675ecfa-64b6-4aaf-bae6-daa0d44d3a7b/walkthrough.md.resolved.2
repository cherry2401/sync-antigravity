# Extension V2 - N8n Webhook Integration Walkthrough

## âœ… TÃ­nh NÄƒng ÄÃ£ Implement

Extension V2 giá» cÃ³ thá»ƒ tá»± Ä‘á»™ng Ä‘á»“ng bá»™ cookies sang N8n webhook!

## ğŸ”§ CÃ¡c Thay Äá»•i

### 1. UI Updates - [sidebar.html](file:///d:/EXTENTIONS/custome-link_v2/sidebar.html)

**ThÃªm section má»›i trong Settings:**
- Input field "N8N Webhook URL"
- Checkbox "Tá»± Ä‘á»™ng Ä‘á»“ng bá»™ sau khi láº¥y cookies"
- Button "Test Webhook"

### 2. Storage & State - [sidebar.js](file:///d:/EXTENTIONS/custome-link_v2/sidebar.js)

**State variables má»›i:**
```javascript
state = {
  webhookUrl: '',    // Webhook URL
  autoSync: false    // Auto-sync enabled/disabled
}
```

**Chrome Storage:**
- `n8n_webhook_url` - LÆ°u webhook URL
- `auto_sync_enabled` - LÆ°u tráº¡ng thÃ¡i auto-sync

### 3. Webhook Sync Function

**Function [syncToWebhook(cookieString, cookieCount)](file:///d:/EXTENTIONS/custome-link_v2/sidebar.js#518-562):**

Gá»­i data Ä‘áº¿n N8n webhook vá»›i format:
```json
{
  "cookies": "SPC_F=...; SPC_ST=...",
  "timestamp": "2025-12-24T12:49:13+07:00",
  "cookie_count": 23,
  "user_id": "1271922156",
  "source": " chrome_extension_v2"
}
```

**Helper function [extractUserId()](file:///d:/EXTENTIONS/custome-link_v2/sidebar.js#512-517):**
- Extract `SPC_U` value tá»« cookie string

### 4. Auto-Sync Integration

Sau khi láº¥y cookies thÃ nh cÃ´ng:
- Check `state.autoSync` vÃ  `state.webhookUrl`
- Náº¿u enabled â†’ Gá»i [syncToWebhook()](file:///d:/EXTENTIONS/custome-link_v2/sidebar.js#518-562)
- Show message: "âœ… ÄÃ£ láº¥y X cookies vÃ  Ä‘á»“ng bá»™ vá»›i N8n!"
- Náº¿u sync fails: "âœ… ÄÃ£ láº¥y X cookies (âš ï¸ Äá»“ng bá»™ tháº¥t báº¡i)"

## ğŸ§ª HÆ°á»›ng Dáº«n Test

### BÆ°á»›c 1: Reload Extension
1. Má»Ÿ `chrome://extensions/`
2. TÃ¬m "Shopee Link Converter"
3. Click Reload

### BÆ°á»›c 2: Cáº¥u HÃ¬nh Webhook
1. Má»Ÿ extension â†’ Settings (âš™ï¸)
2. Nháº­p webhook URL: `https://auto.myphamhaki.id.vn/webhook/api-key-xxx`
3. Check âœ“ "Tá»± Ä‘á»™ng Ä‘á»“ng bá»™ sau khi láº¥y cookies"
4. Click "LÆ°u Cookie & Báº¯t Äáº§u"

### BÆ°á»›c 3: Test Webhook
1. Quay láº¡i Settings
2. Click "ğŸ”„ Test Webhook"
3. Sáº½ hiá»‡n alert: "âœ… Test webhook thÃ nh cÃ´ng!" hoáº·c error message

### BÆ°á»›c 4: Test Auto-Sync
1. Má»Ÿ https://affiliate.shopee.vn (Ä‘Ã£ Ä‘Äƒng nháº­p)
2. Extension â†’ Settings â†’ "ğŸª Láº¥y Cookies Tá»± Äá»™ng"
3. Xem message: Should show "...vÃ  Ä‘á»“ng bá»™ vá»›i N8n!"
4. **Má»Ÿ Console (F12)** Ä‘á»ƒ xem logs:
   ```
   Syncing to webhook: https://...
   Payload: {...}
   âœ… Webhook sync successful: {...}
   ```

### BÆ°á»›c 5: Verify N8n
1. Má»Ÿ n8n workflow editor
2. Check webhook node cÃ³ nháº­n data khÃ´ng
3. Verify data structure Ä‘Ãºng

## ğŸ“Š Webhook Data Structure

N8n webhook nháº­n POST request vá»›i:

```json
{
  "cookies": "SPC_F=...; SPC_T_ID=...; ...",
  "timestamp": "2025-12-24T12:49:13.123Z",
  "cookie_count": 23,
  "user_id": "1271922156",
  "source": "chrome_extension_v2"
}
```

**Fields:**
- `cookies` (string): Cookie string Ä‘áº§y Ä‘á»§
- `timestamp` (ISO string): Thá»i gian sync
- `cookie_count` (number): Sá»‘ lÆ°á»£ng cookies
- `user_id` (string): SPC_U value hoáº·c "unknown"
- `source` (string): LuÃ´n lÃ  "chrome_extension_v2"

## ğŸ¯ Use Cases

### Use Case 1: Auto-Sync Enabled
1. User láº¥y cookies tá»± Ä‘á»™ng
2. Extension tá»± Ä‘á»™ng gá»­i Ä‘áº¿n webhook
3. N8n lÆ°u vÃ o data table
4. User sees: "âœ… ÄÃ£ láº¥y 23 cookies vÃ  Ä‘á»“ng bá»™ vá»›i N8n!"

### Use Case 2: Auto-Sync Disabled
1. User láº¥y cookies tá»± Ä‘á»™ng
2. Extension KHÃ”NG gá»­i webhook
3. User sees: "âœ… ÄÃ£ láº¥y 23 cookies tá»« DevTools!"
4. User cÃ³ thá»ƒ test webhook manually

### Use Case 3: Webhook Fails
1. User láº¥y cookies, auto-sync enabled
2. Webhook URL sai hoáº·c n8n offline
3. Extension váº«n láº¥y cookies OK
4. User sees: "âš ï¸ Äá»“ng bá»™ tháº¥t báº¡i"
5. Console logs error details

## ğŸ” Debugging

**Console logs:**
- "Syncing to webhook: [URL]"
- "Payload: {...}" (vá»›i cookies preview)
- "âœ… Webhook sync successful: {...}"
- "âŒ Webhook sync failed: [error]"

**Check Chrome Storage:**
```javascript
chrome.storage.local.get(['n8n_webhook_url', 'auto_sync_enabled'], console.log)
```

## âš ï¸ LÆ°u Ã

- Webhook URL Ä‘Æ°á»£c lÆ°u trong Chrome storage local
- Auto-sync chá»‰ cháº¡y khi CÃ“ webhook URL
- Sync failures KHÃ”NG block viá»‡c láº¥y cookies
- User ID extract tá»« cookie `SPC_U`
- Error handling: try-catch vá»›i fallback graceful

## ğŸ“ Káº¿t Luáº­n

Extension V2 Ä‘Ã£ cÃ³ Ä‘áº§y Ä‘á»§ tÃ­nh nÄƒng:
- âœ… Webhook URL configuration
- âœ… Auto-sync toggle
- âœ… Test webhook button  
- âœ… Auto-sync after cookie fetch
- âœ… Error handling & logging
- âœ… Chrome storage integration

**ÄÃ£ sáºµn sÃ ng Ä‘á»ƒ test vÃ  deploy!** ğŸš€
