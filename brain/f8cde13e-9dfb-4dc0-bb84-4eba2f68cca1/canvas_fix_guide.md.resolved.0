# H∆∞·ªõng D·∫´n S·ª≠a L·ªói Upload Image Tr√™n n8n Canvas

## üéØ B·∫°n C·∫ßn S·ª≠a 2 ƒêi·ªÉm

### ‚úÖ Fix 1: Th√™m mimeType v√†o Convert to Base64 Node

1. **M·ªü workflow VEO3_V2** trong n8n
2. **Click v√†o node "Convert to Base64"** (node sau Download Photo)
3. **Trong tab Parameters**, t√¨m ƒë·∫øn code JavaScript
4. **S·ª≠a code** t·ª´:

```javascript
const binaryData = $input.item.binary.data;
const base64String = binaryData.data;
// Lo·∫°i b·ªè data prefix n·∫øu c√≥
const cleanBase64 = base64String.replace(/^data:image\/\w+;base64,/, "");

return {
  json: {
    base64: cleanBase64,
    length: cleanBase64.length
  }
};
```

**Th√†nh:**

```javascript
const binaryData = $input.item.binary.data;
const base64String = binaryData.data;
// Lo·∫°i b·ªè data prefix n·∫øu c√≥
const cleanBase64 = base64String.replace(/^data:image\/\w+;base64,/, "");

// L·∫•y mimeType t·ª´ binary data
const mimeType = binaryData.mimeType || 'image/png';

return {
  json: {
    base64: cleanBase64,
    mimeType: mimeType,
    length: cleanBase64.length
  }
};
```

5. **Click "Execute Node"** ƒë·ªÉ test
6. Ki·ªÉm tra Output ph·∫£i c√≥ 3 fields: `base64`, `mimeType`, `length`

---

### ‚úÖ Fix 2: S·ª≠a Upload Image Node (Downgrade typeVersion)

> [!IMPORTANT]
> Fix n√†y **KH√îNG TH·ªÇ** l√†m tr·ª±c ti·∫øp tr√™n canvas UI v√¨ n8n kh√¥ng cho ph√©p thay ƒë·ªïi `typeVersion` qua giao di·ªán.

#### C√°ch 1: X√≥a v√† T·∫°o L·∫°i Node (Khuy·∫øn ngh·ªã)

1. **Copy c·∫•u h√¨nh hi·ªán t·∫°i** c·ªßa node Upload Image:
   - URL: `https://aisandbox-pa.googleapis.com/v1:uploadUserImage`
   - Method: `POST`
   - Headers:
     ```json
     {
       "Authorization": $json.token,
       "Content-Type": "text/plain;charset=UTF-8"
     }
     ```
   - Body: `{{ $json.payload }}`

2. **X√≥a node Upload Image** hi·ªán t·∫°i

3. **Th√™m node HTTP Request m·ªõi**:
   - K√©o t·ª´ toolbar v√†o canvas
   - n8n s·∫Ω t·ª± ƒë·ªông t·∫°o node v·ªõi typeVersion m·ªõi nh·∫•t

4. **C·∫•u h√¨nh l·∫°i** theo th√¥ng tin ƒë√£ copy ·ªü b∆∞·ªõc 1

5. **N·ªëi l·∫°i connections**:
   - Input: t·ª´ "Prepare Upload Payload"
   - Output: ƒë·∫øn "Extract Media ID"

#### C√°ch 2: S·ª≠a Tr·ª±c Ti·∫øp File JSON (Nhanh h∆°n)

1. **ƒê√≥ng workflow** trong n8n (ƒë·ªÉ tr√°nh conflict)

2. **M·ªü file** [VEO3_V2.json](file:///i:/Workflow/n8n/Test/VEO3/VEO3_V2.json) trong VS Code

3. **T√¨m d√≤ng 644**:
   ```json
   "typeVersion": 4.2,
   ```

4. **S·ª≠a th√†nh**:
   ```json
   "typeVersion": 3,
   ```

5. **L∆∞u file** (Ctrl + S)

6. **Quay l·∫°i n8n v√† reload workflow**

---

## üß™ Ki·ªÉm Tra Sau Khi S·ª≠a

### Test Workflow

1. **G·ª≠i 1 ·∫£nh** qua Telegram bot
2. **Ki·ªÉm tra node Convert to Base64**:
   - Output ph·∫£i c√≥ `mimeType` (vd: `image/jpeg`)
   - `base64` ph·∫£i kh√¥ng c√≥ prefix `data:image/...`
3. **Ki·ªÉm tra node Upload Image**:
   - Kh√¥ng c√≤n l·ªói "Bad request"
   - Output ph·∫£i c√≥ `mediaGenerationId`
4. **Xem video ƒë∆∞·ª£c t·∫°o** g·ª≠i v·ªÅ Telegram

### N·∫øu V·∫´n L·ªói

- Ki·ªÉm tra token c√≥ c√≤n valid kh√¥ng
- Ki·ªÉm tra base64 c√≥ b·ªã c·∫Øt/sai format kh√¥ng
- Check browser console trong n8n ƒë·ªÉ xem error chi ti·∫øt

---

## üìå T√≥m T·∫Øt

| S·ª≠a | N∆°i | C√°ch |
|-----|-----|------|
| **Th√™m mimeType** | Convert to Base64 node | S·ª≠a code tr√™n canvas |
| **H·∫° typeVersion** | Upload Image node | S·ª≠a file JSON ho·∫∑c x√≥a/t·∫°o l·∫°i node |
