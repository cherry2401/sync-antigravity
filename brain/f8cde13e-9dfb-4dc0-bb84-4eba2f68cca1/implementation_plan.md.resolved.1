# Fix VEO3_V2 Telegram Image Upload Error

## üéØ V·∫•n ƒê·ªÅ ƒê√£ X√°c ƒê·ªãnh

Sau khi ph√¢n t√≠ch, **nguy√™n nh√¢n ch√≠nh** l√†:

> [!IMPORTANT]
> **VEO3_V2** x·ª≠ l√Ω ·∫£nh t·ª´ **Telegram binary data**, trong khi **VEO3_ImageUpload_Fixed_V3** download ·∫£nh t·ª´ **URL**. 
> 
> Khi Telegram tr·∫£ v·ªÅ binary data, n8n t·ª± ƒë·ªông encode sang base64 **V·ªöI data URI prefix** (`data:image/jpeg;base64,...`), nh∆∞ng Google AI API ch·ªâ ch·∫•p nh·∫≠n **raw base64** (kh√¥ng c√≥ prefix).

### Screenshots Minh H·ªça

````carousel
![Upload Image l·ªói Bad Request trong VEO3_V2](C:/Users/Cherry/.gemini/antigravity/brain/f8cde13e-9dfb-4dc0-bb84-4eba2f68cca1/uploaded_image_1_1765131168267.png)
<!-- slide -->
![Convert to Base64 output v·ªõi base64 r·∫•t d√†i (c√≥ data URI prefix)](C:/Users/Cherry/.gemini/antigravity/brain/f8cde13e-9dfb-4dc0-bb84-4eba2f68cca1/uploaded_image_0_1765131168267.png)
````

## üîç So S√°nh Code

### ‚ùå VEO3_V2 - Convert to Base64 (Hi·ªán t·∫°i - L·ªói)

[Convert to Base64](file:///i:/Workflow/n8n/Test/VEO3/VEO3_V2.json#L500-L501)

```javascript
const binaryData = $input.item.binary.data;
const base64 = binaryData.data;  // ‚Üê Kh√¥ng l√†m s·∫°ch!

return {
  json: {
    base64: base64,  // ‚Üê C√≥ th·ªÉ ch·ª©a: data:image/jpeg;base64,iVBORw0...
    length: base64.length
  }
};
```

### ‚úÖ VEO3_ImageUpload_Fixed_V3 - Convert to Base64 (Th√†nh c√¥ng)

[Convert to Base64](file:///i:/Workflow/n8n/Test/VEO3/VEO3_ImageUpload_Fixed_V3.json#L26)

```javascript
const binaryData = items[0].binary.data;
const base64String = binaryData.data;
// Ensure no data prefix
const cleanBase64 = base64String.replace(/^data:image\/\w+;base64,/, ""); // ‚Üê L√†m s·∫°ch!

return [{
  json: {
    base64: cleanBase64,  // ‚Üê Ch·ªâ ch·ª©a: iVBORw0...
    token: $('Mock Input1').item.json.token
  }
}];
```

## üìã Proposed Changes

### [MODIFY] [VEO3_V2.json](file:///i:/Workflow/n8n/Test/VEO3/VEO3_V2.json)

#### Node: Convert to Base64 (lines 500-501)

**Thay ƒë·ªïi code t·ª´:**
```javascript
const binaryData = $input.item.binary.data;
const base64 = binaryData.data;

return {
  json: {
    base64: base64,
    length: base64.length
  }
};
```

**Sang:**
```javascript
const binaryData = $input.item.binary.data;
const base64String = binaryData.data;

// Remove data URI prefix if present (e.g., data:image/jpeg;base64,)
const cleanBase64 = base64String.replace(/^data:image\/\w+;base64,/, "");

return {
  json: {
    base64: cleanBase64,
    length: cleanBase64.length
  }
};
```

## ‚úÖ Verification Plan

### Manual Verification
1. G·ª≠i 1 ·∫£nh qua Telegram bot
2. Ki·ªÉm tra output c·ªßa node **Convert to Base64** - base64 ph·∫£i kh√¥ng c√≥ prefix `data:image/...`
3. Ki·ªÉm tra node **Upload Image** - ph·∫£i tr·∫£ v·ªÅ `mediaGenerationId` th√†nh c√¥ng
4. Ki·ªÉm tra video ƒë∆∞·ª£c t·∫°o v√† g·ª≠i v·ªÅ Telegram

