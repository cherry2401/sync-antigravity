# Fix VEO3_V2 Telegram Image Upload Error

## üéØ C·∫≠p Nh·∫≠t: B·∫°n ƒê√£ S·ª≠a Base64 R·ªìi Nh∆∞ng V·∫´n L·ªói!

> [!IMPORTANT]
> Sau khi xem screenshot, b·∫°n **ƒê√É TH√äM** code l√†m s·∫°ch base64:
> ```javascript
> const cleanBase64 = base64String.replace(/^data:image\/\w+;base64,/, "");
> ```
> 
> **Nh∆∞ng v·∫´n b·ªã l·ªói!** C√≥ **2 v·∫•n ƒë·ªÅ c√≤n l·∫°i** c·∫ßn s·ª≠a:

### Screenshots X√°c Nh·∫≠n

![User ƒë√£ s·ª≠a Convert to Base64 v·ªõi regex cleaning](C:/Users/Cherry/.gemini/antigravity/brain/f8cde13e-9dfb-4dc0-bb84-4eba2f68cca1/uploaded_image_1765131406776.png)

---

## üîç Ph√¢n T√≠ch ƒê·∫ßy ƒê·ªß T·∫•t C·∫£ S·ª± Kh√°c Bi·ªát

| Kh√≠a c·∫°nh | VEO3_ImageUpload_Fixed_V3 ‚úÖ | VEO3_V2 ‚ùå |
|-----------|------------------------------|------------|
| **Base64 cleaning** | ‚úÖ C√≥ regex | ‚úÖ **B·∫°n ƒë√£ s·ª≠a** |
| **HTTP typeVersion** | `3` | `4.2` ‚Üê **V·∫•n ƒë·ªÅ 1** |
| **mimeType trong Convert** | ‚ùå Kh√¥ng c√≥ | ‚ùå Kh√¥ng c√≥ |
| **mimeType trong Prepare** | Hardcode `image/png` | D√πng `$json.mimeType` ‚Üê **V·∫•n ƒë·ªÅ 2** |

---

## ‚ö†Ô∏è V·∫•n ƒê·ªÅ 1: HTTP Request typeVersion 4.2

### Upload Image Node - Kh√°c Bi·ªát Quan Tr·ªçng

**VEO3_V2** (L·ªói):
```json
{
  "type": "n8n-nodes-base.httpRequest",
  "typeVersion": 4.2  // ‚Üê Version m·ªõi, x·ª≠ l√Ω headers kh√°c
}
```

**VEO3_ImageUpload_Fixed_V3** (Th√†nh c√¥ng):
```json
{
  "type": "n8n-nodes-base.httpRequest",
  "typeVersion": 3  // ‚Üê Version c≈©, ·ªïn ƒë·ªãnh v·ªõi Google API
}
```

> [!WARNING]
> HTTP Request node **version 4.2** x·ª≠ l√Ω `specifyHeaders: "json"` strict h∆°n, g√¢y conflict khi combine v·ªõi `jsonHeaders`. Google API kh√¥ng ch·∫•p nh·∫≠n format n√†y!

---

## ‚ö†Ô∏è V·∫•n ƒê·ªÅ 2: Missing mimeType Field

### Edit Fields (Image) Node

**VEO3_V2** d√≤ng 574-577:
```json
{
  "id": "img-mimetype-07",
  "name": "mimeType",
  "value": "={{ $('Convert to Base64').item.json.mimeType }}",  // ‚Üê Nh∆∞ng Convert to Base64 KH√îNG TR·∫¢ V·ªÄ mimeType!
  "type": "string"
}
```

**Convert to Base64** CH·ªà tr·∫£ v·ªÅ:
```javascript
return {
  json: {
    base64: cleanBase64,
    length: cleanBase64.length
    // ‚Üê THI·∫æU mimeType!
  }
};
```

‚Üí K·∫øt qu·∫£: `$json.mimeType` = `undefined` ho·∫∑c empty string  
‚Üí **Prepare Upload Payload** t·∫°o payload v·ªõi mimeType r·ªóng  
‚Üí **Google API b√°o l·ªói "Invalid argument"**

---

## üìã Proposed Changes

### 1. [MODIFY] Upload Image Node - H·∫° TypeVersion

[Upload Image](file:///i:/Workflow/n8n/Test/VEO3/VEO3_V2.json#L630-L650), d√≤ng 644:

```json
"typeVersion": 4.2  ‚Üí  "typeVersion": 3
```

### 2. [MODIFY] Convert to Base64 Node - Th√™m mimeType

[Convert to Base64](file:///i:/Workflow/n8n/Test/VEO3/VEO3_V2.json#L500-L501):

**Code hi·ªán t·∫°i:**
```javascript
const binaryData = $input.item.binary.data;
const base64String = binaryData.data;
const cleanBase64 = base64String.replace(/^data:image\/\w+;base64,/, "");

return {
  json: {
    base64: cleanBase64,
    length: cleanBase64.length
  }
};
```

**Code m·ªõi:**
```javascript
const binaryData = $input.item.binary.data;
const base64String = binaryData.data;
const cleanBase64 = base64String.replace(/^data:image\/\w+;base64,/, "");

// Get mimeType from binary data
const mimeType = binaryData.mimeType || 'image/png';

return {
  json: {
    base64: cleanBase64,
    mimeType: mimeType,
    length: cleanBase64.length
  }
};
```

---

## ‚úÖ Verification Plan

### Automated Tests
1. Upload ·∫£nh test qua Telegram
2. Ki·ªÉm tra output node **Convert to Base64**: 
   - `base64` kh√¥ng c√≥ prefix
   - `mimeType` c√≥ gi√° tr·ªã (v√≠ d·ª•: `image/jpeg`)
3. Ki·ªÉm tra **Upload Image** response c√≥ `mediaGenerationId`

### Manual Verification
1. G·ª≠i ·∫£nh JPEG qua Telegram bot
2. G·ª≠i ·∫£nh PNG qua Telegram bot
3. X√°c nh·∫≠n c·∫£ 2 ƒë·ªÅu t·∫°o video th√†nh c√¥ng


