# Ph√¢n T√≠ch L·ªói Upload Image - VEO3 Workflows

## üîç T·ªïng Quan V·∫•n ƒê·ªÅ

Workflow **VEO3_ImageUpload_Fixed_V3** ho·∫°t ƒë·ªông th√†nh c√¥ng khi upload ·∫£nh, trong khi **VEO3_V2.json** li√™n t·ª•c g·∫∑p l·ªói **"Bad request - please check your parameters"** t·∫°i node Upload Image.

## ‚ö†Ô∏è Nguy√™n Nh√¢n Ch√≠nh

Sau khi ph√¢n t√≠ch chi ti·∫øt, t√¥i ph√°t hi·ªán **s·ª± kh√°c bi·ªát quan tr·ªçng** gi·ªØa hai workflow:

### üìå ƒêi·ªÉm Kh√°c Bi·ªát S·ªë 1: `typeVersion` c·ªßa HTTP Request Node

| Workflow | typeVersion | K·∫øt qu·∫£ |
|----------|-------------|---------|
| **VEO3_ImageUpload_Fixed_V3** | `3` | ‚úÖ Th√†nh c√¥ng |
| **VEO3_V2** | `4.2` | ‚ùå L·ªói Bad Request |

### üìå ƒêi·ªÉm Kh√°c Bi·ªát S·ªë 2: X·ª≠ l√Ω Base64

**VEO3_ImageUpload_Fixed_V3** c√≥ b∆∞·ªõc l√†m s·∫°ch base64:
```javascript
// Convert to Base64 node
const cleanBase64 = base64String.replace(/^data:image\/\w+;base64,/, "");
```

**VEO3_V2** kh√¥ng c√≥ b∆∞·ªõc n√†y:
```javascript
// Convert to Base64 node
return {
  json: {
    base64: base64,  // Base64 th√¥, ch∆∞a ƒë∆∞·ª£c l√†m s·∫°ch
    length: base64.length
  }
};
```

---

## üìä So S√°nh Chi Ti·∫øt Upload Image Node

### ‚úÖ VEO3_ImageUpload_Fixed_V3 (Th√†nh c√¥ng)

[Upload Image](file:///i:/Workflow/n8n/Test/VEO3/VEO3_ImageUpload_Fixed_V3.json#L91-L111)

```json
{
  "parameters": {
    "method": "POST",
    "url": "https://aisandbox-pa.googleapis.com/v1:uploadUserImage",
    "sendHeaders": true,
    "specifyHeaders": "json",
    "jsonHeaders": "={{ JSON.stringify({...}) }}",
    "sendBody": true,
    "contentType": "raw",
    "rawContentType": "text/plain",
    "body": "={{ $json.payload }}",
    "options": {}
  },
  "type": "n8n-nodes-base.httpRequest",
  "typeVersion": 3  // ‚Üê Phi√™n b·∫£n 3
}
```

### ‚ùå VEO3_V2 (L·ªói)

[Upload Image](file:///i:/Workflow/n8n/Test/VEO3/VEO3_V2.json#L631-L650)

```json
{
  "parameters": {
    "method": "POST",
    "url": "https://aisandbox-pa.googleapis.com/v1:uploadUserImage",
    "sendHeaders": true,
    "specifyHeaders": "json",
    "jsonHeaders": "={{ JSON.stringify({...}) }}",
    "sendBody": true,
    "contentType": "raw",
    "rawContentType": "text/plain",
    "body": "={{ $json.payload }}",
    "options": {}
  },
  "type": "n8n-nodes-base.httpRequest",
  "typeVersion": 4.2  // ‚Üê Phi√™n b·∫£n 4.2
}
```

---

## üîß Gi·∫£i Ph√°p S·ª≠a L·ªói

### C√°ch 1: H·∫° Phi√™n B·∫£n HTTP Request Node (Khuy·∫øn ngh·ªã)

Thay ƒë·ªïi `typeVersion` t·ª´ `4.2` xu·ªëng `3` trong node **Upload Image** c·ªßa VEO3_V2:

```json
"typeVersion": 3
```

### C√°ch 2: C·∫≠p Nh·∫≠t Code L√†m S·∫°ch Base64

Trong node **Convert to Base64** c·ªßa VEO3_V2, thay th·∫ø code hi·ªán t·∫°i:

**Code hi·ªán t·∫°i:**
```javascript
const binaryData = $input.item.binary.data;
const base64 = binaryData.data;

return {
  json: {
    base64: base64,
    length: base64.length
  }
};
```

**Code m·ªõi (ƒë√£ l√†m s·∫°ch):**
```javascript
const binaryData = $input.item.binary.data;
const base64String = binaryData.data;
// Lo·∫°i b·ªè data prefix n·∫øu c√≥
const cleanBase64 = base64String.replace(/^data:image\/\w+;base64,/, "");

return {
  json: {
    base64: cleanBase64,
    length: cleanBase64.length
  }
};
```

---

## üí° Gi·∫£i Th√≠ch K·ªπ Thu·∫≠t

### T·∫°i Sao typeVersion 4.2 G√¢y L·ªói?

n8n HTTP Request node version 4.2 c√≥ c√°ch x·ª≠ l√Ω headers v√† body kh√°c so v·ªõi version 3:

- **Version 3**: X·ª≠ l√Ω `specifyHeaders: "json"` m·ªôt c√°ch linh ho·∫°t h∆°n
- **Version 4.2**: Strict h∆°n v·ªõi format headers, c√≥ th·ªÉ g√¢y conflict khi k·∫øt h·ª£p v·ªõi `jsonHeaders`

### T·∫°i Sao C·∫ßn L√†m S·∫°ch Base64?

Google AI API y√™u c·∫ßu base64 **thu·∫ßn t√∫y** (raw base64), kh√¥ng ch·∫•p nh·∫≠n format:
```
data:image/png;base64,iVBORw0KGgoAAAANS...
```

Ch·ªâ ch·∫•p nh·∫≠n:
```
iVBORw0KGgoAAAANS...
```

---

## ‚ú® K·∫øt Lu·∫≠n

L·ªói x·∫£y ra do **s·ª± kh√¥ng t∆∞∆°ng th√≠ch** gi·ªØa HTTP Request node version 4.2 v·ªõi c√°ch Google API x·ª≠ l√Ω request. Workflow Fixed_V3 s·ª≠ d·ª•ng version 3 n√™n ho·∫°t ƒë·ªông ·ªïn ƒë·ªãnh.

**H√†nh ƒë·ªông khuy·∫øn ngh·ªã**: H·∫° `typeVersion` xu·ªëng `3` trong node Upload Image c·ªßa VEO3_V2.
