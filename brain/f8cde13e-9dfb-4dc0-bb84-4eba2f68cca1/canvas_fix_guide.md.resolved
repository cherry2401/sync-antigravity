# HÆ°á»›ng Dáº«n Sá»­a TrÃªn n8n Canvas (KHÃ”NG Cáº¦N EDIT FILE)

## ğŸ¯ Váº¥n Äá» Cáº§n Sá»­a

Sau khi phÃ¢n tÃ­ch, workflow cá»§a báº¡n cÃ³ **3 váº¥n Ä‘á»**:

1. âœ… **Base64 cleaning** - Báº¡n Ä‘Ã£ sá»­a rá»“i
2. âš ï¸ **Thiáº¿u mimeType** trong output cá»§a Convert to Base64
3. âŒ **TypeVersion 4.2** cá»§a Upload Image node (KHÃ”NG THá»‚ sá»­a trÃªn canvas)

---

## âœ… CÃ¡ch Sá»­a TrÃªn Canvas

### BÆ°á»›c 1: Sá»­a Node "Convert to Base64"

> ThÃªm mimeType vÃ o output

1. **Má»Ÿ workflow VEO3_V2** trong n8n
2. **Click vÃ o node "Convert to Base64"** (node cÃ³ icon code)
3. Báº¡n sáº½ tháº¥y code JavaScript hiá»‡n táº¡i:

```javascript
const binaryData = $input.item.binary.data;
const base64String = binaryData.data;
const cleanBase64 = base64String.replace(/^data:image\/\w+;base64,/, "");

return {
  json: {
    base64: cleanBase64,
    length: cleanBase64.length
  }
};
```

4. **ThÃªm 2 dÃ²ng code** (sau dÃ²ng `cleanBase64`):

```javascript
// Láº¥y mimeType tá»« binary data
const mimeType = binaryData.mimeType || 'image/png';
```

5. **ThÃªm mimeType vÃ o return**:

```javascript
return {
  json: {
    base64: cleanBase64,
    mimeType: mimeType,    // â† ThÃªm dÃ²ng nÃ y
    length: cleanBase64.length
  }
};
```

6. **Code hoÃ n chá»‰nh sáº½ lÃ **:

```javascript
const binaryData = $input.item.binary.data;
const base64String = binaryData.data;
const cleanBase64 = base64String.replace(/^data:image\/\w+;base64,/, "");

// Láº¥y mimeType tá»« binary data
const mimeType = binaryData.mimeType || 'image/png';

return {
  json: {
    base64: cleanBase64,
    mimeType: mimeType,
    length: cleanBase64.length
  }
};
```

7. **Click "Save"** hoáº·c Ä‘Ã³ng node editor

---

### BÆ°á»›c 2: Sá»­a Node "Prepare Upload Payload"

> DÃ¹ng mimeType Ä‘á»™ng thay vÃ¬ hardcode

1. **Click vÃ o node "Prepare Upload Payload"**
2. TÃ¬m field **"payload"** trong pháº§n Values
3. Báº¡n sáº½ tháº¥y expression hiá»‡n táº¡i cÃ³:

```
"mimeType": "image/png"
```

4. **Thay Ä‘á»•i thÃ nh**:

```
"mimeType": {{ $json.mimeType }}
```

5. **Expression hoÃ n chá»‰nh sáº½ lÃ **:

```javascript
{{ JSON.stringify({
  "imageInput": {
    "rawImageBytes": $json.base64,
    "mimeType": $json.mimeType       // â† Äá»•i tá»« "image/png" thÃ nh $json.mimeType
  },
  "clientContext": {
    "tool": "ASSET_MANAGER"
  }
}) }}
```

6. **Click "Save"** hoáº·c Ä‘Ã³ng node editor

---

### âš ï¸ BÆ°á»›c 3: Upload Image Node - TypeVersion (Váº¤N Äá»€)

> [!WARNING]
> **Váº¥n Ä‘á» typeVersion KHÃ”NG THá»‚ sá»­a trá»±c tiáº¿p trÃªn canvas UI!**

n8n khÃ´ng cho phÃ©p thay Ä‘á»•i `typeVersion` qua giao diá»‡n. Báº¡n cÃ³ **2 lá»±a chá»n**:

#### Lá»±a chá»n A: XÃ³a vÃ  Táº¡o Láº¡i Node (Khuyáº¿n nghá»‹)

1. **Click vÃ o node "Upload Image"**
2. **Copy/ghi nhá»›** cáº¥u hÃ¬nh:
   - Method: `POST`
   - URL: `https://aisandbox-pa.googleapis.com/v1:uploadUserImage`
   - Send Headers: âœ… ON
   - Specify Headers: `Using JSON`
   - JSON: 
     ```json
     {
       "Authorization": {{ $json.token }},
       "Content-Type": "text/plain;charset=UTF-8"
     }
     ```
   - Send Body: âœ… ON
   - Body Content Type: `Raw`
   - Content Type: `text/plain`
   - Body: `{{ $json.payload }}`

3. **XÃ³a node "Upload Image"**
4. **ThÃªm node HTTP Request má»›i**:
   - Tá»« toolbar, kÃ©o "HTTP Request" vÃ o canvas
   - n8n sáº½ tá»± Ä‘á»™ng táº¡o vá»›i typeVersion má»›i

5. **Cáº¥u hÃ¬nh láº¡i** theo thÃ´ng tin Ä‘Ã£ copy á»Ÿ bÆ°á»›c 2
6. **Ná»‘i láº¡i connections**:
   - Input: tá»« "Prepare Upload Payload"
   - Output: Ä‘áº¿n "Extract Media ID"

#### Lá»±a chá»n B: Cháº¥p Nháº­n Sá»­a File JSON (1 dÃ²ng duy nháº¥t)

1. **ÄÃ³ng workflow** trong n8n
2. **Má»Ÿ file [VEO3_V2.json](file:///i:/Workflow/n8n/Test/VEO3/VEO3_V2.json)** trong VS Code
3. **TÃ¬m dÃ²ng 644** (hoáº·c search "typeVersion": 4.2)
4. **Sá»­a**: `"typeVersion": 4.2,` â†’ `"typeVersion": 3,`
5. **LÆ°u file** (Ctrl + S)
6. **Quay láº¡i n8n**, reload workflow

---

## ğŸ§ª Kiá»ƒm Tra

Sau khi sá»­a xong:

1. **Gá»­i 1 áº£nh** qua Telegram bot
2. **Click vÃ o node "Convert to Base64"** â†’ Tab Output
   - Pháº£i tháº¥y: `base64`, `mimeType`, `length`
3. **Click vÃ o node "Upload Image"** â†’ Tab Output
   - KhÃ´ng cÃ²n lá»—i "Bad request"
   - Pháº£i cÃ³ `mediaGenerationId`

---

## ğŸ“Œ TÃ³m Táº¯t

| Sá»­a | NÆ¡i | CÃ³ thá»ƒ sá»­a trÃªn Canvas? |
|-----|-----|------------------------|
| ThÃªm mimeType | Convert to Base64 | âœ… ÄÆ°á»£c - sá»­a code |
| DÃ¹ng mimeType Ä‘á»™ng | Prepare Upload Payload | âœ… ÄÆ°á»£c - sá»­a expression |
| Háº¡ typeVersion | Upload Image | âŒ KhÃ´ng - pháº£i xÃ³a/táº¡o láº¡i hoáº·c edit file |

